{% extends 'adminside/base.html' %}
{% load static %}
{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.26/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Sales Report</h2>
            <p>Comprehensive data about your orders is available here</p>
        </div>
        <div class="d-flex gap-2">
            <button id="download-pdf" class="btn btn-primary">
                <i class="material-icons md-post_add"></i> Download as PDF
            </button>
            <button id="download-excel" class="btn btn-primary">
                <i class="material-icons md-post_add"></i> Download as Excel
            </button>
        </div>
    </div>

    <div class="mb-4">
        <form method="post" action="{% url 'sales_report' %}" class="row g-2">
            {% csrf_token %}
            <div class="col-auto d-flex align-items-center">
                <h5 class="mb-0">Start Date:</h5>
            </div>
            <div class="col-auto">
                <input type="date" name="start_date" class="form-control" placeholder="Start date" value="{{ start_date|default:'' }}">
            </div>
            <div class="col-auto d-flex align-items-center">
                <h5 class="mb-0">End Date:</h5>
            </div>
            <div class="col-auto">
                <input type="date" name="end_date" class="form-control" placeholder="End date" value="{{ end_date|default:'' }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="sales-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>Date</th>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Order Total</th>
                            <th>Payment Method</th>
                            <th>Coupon</th>
                            <th>Products</th> <!-- Added column for products -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            <tr>
                                <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                                <td>{{ order.uuid }}</td>
                                <td>{{ order.user.username }}</td>
                                <td>{{ order.total_price }}</td>
                                <td>{{ order.get_payment_method_display }}</td>
                                <td>{{ order.coupon_discount  }}</td>
                                <td>
                                    <ul>
                                    {% for item in order.items.all %}
                                        <li>{{ item.product.product_name }} ({{ item.variant|default:"N/A" }}): {{ item.quantity }}</li>
                                    {% empty %}
                                        <li>No products</li>
                                    {% endfor %}
                                    </ul>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7">No orders found</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <h3 class="mt-4">Total Sales: {{ total_sales|floatformat:2 }}</h3>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h4>Product Details</h4>
            <div class="table-responsive">
                <table class="table table-striped" id="product-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>Product Name</th>
                            <th>Total Quantity Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in product_counts %}
                            <tr>
                                <td>{{ product.product__product_name }}</td>
                                <td>{{ product.total_quantity }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2">No products found</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');

    document.getElementById('download-pdf').addEventListener('click', function () {
        console.log('PDF download button clicked');
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            console.error('jsPDF not loaded');
            alert('PDF library not loaded. Please check your internet connection and try again.');
            return;
        }

        fetch('{% url "sales_report" %}', {
            method: 'POST',
            body: new URLSearchParams(new FormData(document.querySelector('form'))),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);

            const doc = new jsPDF();

            // Generate PDF content
            doc.text("Sales Report", 14, 22);

            // Orders table
            doc.autoTable({
                head: [['Date', 'Order ID', 'Customer', 'Order Total', 'Payment Method', 'Coupon']],
                body: data.orders.map(order => [
                    new Date(order.created_at).toLocaleDateString(),
                    order.uuid,
                    order.user__username,
                    order.total_price,
                    order.payment_method,
                    order.coupon_code || 'Nil'
                ]),
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 12, fontStyle: 'bold' },
                bodyStyles: { fontSize: 10, halign: 'center' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 40 }
            });

            doc.text(`Total Sales: ${data.total_sales.toFixed(2)}`, 14, doc.autoTable.previous.finalY + 10);

            // Product details table
            doc.addPage();
            doc.text("Product Details", 14, 22);
            doc.autoTable({
                head: [['Product Name', 'Total Quantity Sold']],
                body: data.product_counts.map(item => [item.product__product_name, item.total_quantity]),
                startY: 30,
                theme: 'striped',
                headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255], fontSize: 12, fontStyle: 'bold' },
                bodyStyles: { fontSize: 10, halign: 'center' },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                margin: { top: 40 }
            });

            doc.save('sales-report.pdf');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating the PDF. Please check the console for more details.');
        });
    });

    document.getElementById('download-excel').addEventListener('click', function () {
        console.log('Excel download button clicked');
        if (!XLSX) {
            console.error('XLSX library not loaded');
            alert('Excel library not loaded. Please check your internet connection and try again.');
            return;
        }

        fetch('{% url "sales_report" %}', {
            method: 'POST',
            body: new URLSearchParams(new FormData(document.querySelector('form'))),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);

            const wb = XLSX.utils.book_new();

            // Orders sheet
            const ws1 = XLSX.utils.json_to_sheet(data.orders.map(order => ({
                Date: new Date(order.created_at).toLocaleDateString(),
                'Order ID': order.uuid,
                Customer: order.user__username,
                'Order Total': order.total_price,
                'Payment Method': order.payment_method,
                Coupon: order.coupon_code || 'Nil'
            })));
            XLSX.utils.book_append_sheet(wb, ws1, 'Orders');

            // Product details sheet
            const ws2 = XLSX.utils.json_to_sheet(data.product_counts);
            XLSX.utils.book_append_sheet(wb, ws2, 'Product Details');

            XLSX.writeFile(wb, 'sales-report.xlsx');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating the Excel file. Please check the console for more details.');
        });
    });
});
</script>

{% endblock %}